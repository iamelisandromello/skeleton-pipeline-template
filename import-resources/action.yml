# üìÑ import-resources.yml
# Action: Condicionalmente importa recursos AWS para o Terraform
# Objetivo: Verifica se recurso j√° existe e, se sim, importa via Terraform, sen√£o cria novo
name: Import existing AWS resources
description: "Importa condicionalmente recursos AWS j√° existentes para o Terraform state."

inputs:
  aws_access_key_id:
    description: AWS Access Key ID
    required: true
  aws_secret_access_key:
    description: AWS Secret Access Key
    required: true
  aws_region:
    description: Regi√£o da AWS
    required: true
  project_name:
    description: Nome do projeto
    required: true
  environment:
    description: "Nome do ambiente (ex: dev, prod)"
    required: true
  terraform_path:
    description: Caminho para o diret√≥rio com os arquivos Terraform e script import.sh (default terraform)
    required: false
    default: terraform

  # Input existente: Para controlar a cria√ß√£o e importa√ß√£o da SQS
  create_sqs_queue:
    description: "Define se uma NOVA fila SQS deve ser criada e importada (true/false)."
    required: false
    default: "true"

  # NOVOS INPUTS: Para SQS Existente e Lambda Function Name
  use_existing_sqs_trigger:
    description: "Define se uma fila SQS existente ser√° usada como trigger para a Lambda e se deve ser importada."
    required: false
    type: string # Receber√° "true" ou "false" como string
    default: "false"

  existing_sqs_queue_arn:
    description: "O ARN da fila SQS existente a ser usada como trigger (requer use_existing_sqs_trigger=true)."
    required: false
    type: string
    default: "" # Valor padr√£o vazio

  lambda_function_name:
    description: "Nome da fun√ß√£o Lambda para a qual a trigger SQS ser√° associada (necess√°rio para importa√ß√£o da trigger)."
    required: true # Essencial para identificar a trigger existente
    type: string

runs:
  using: composite
  steps:
    # -------------------------------
    # üîÑ IMPORT EXISTING RESOURCES
    # -------------------------------   
    # üì§ Verifica a exist√™ncia e realiza a chamada para o script de imports
    - name: Importar recursos existentes
      shell: bash
      run: |
        set -e
      
        if [ ! -f "${GITHUB_ACTION_PATH}/scripts/import.sh" ]; then
          echo "‚ùå Script import.sh n√£o encontrado."
          exit 1
        fi
        bash "${GITHUB_ACTION_PATH}/scripts/import.sh"

        set +e
      env:
        # TODAS as vari√°veis de ambiente mapeadas a partir dos inputs.
        # Nenhuma vari√°vel global do job da pipeline deve ser referenciada diretamente aqui.
        AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
        AWS_REGION: ${{ inputs.aws_region }}
        PROJECT_NAME: ${{ inputs.project_name }}
        ENVIRONMENT: ${{ inputs.environment }}
        TERRAFORM_PATH: ${{ inputs.terraform_path }} # Passar terraform_path para o script

        # Vari√°veis de controle da SQS e trigger (inclu√≠das corretamente agora)
        CREATE_SQS_QUEUE: ${{ inputs.create_sqs_queue }} 
        USE_EXISTING_SQS_TRIGGER: ${{ inputs.use_existing_sqs_trigger }}
        EXISTING_SQS_QUEUE_ARN: ${{ inputs.existing_sqs_queue_arn }}
        LAMBDA_FUNCTION_NAME: ${{ inputs.lambda_function_name }} # Novo input para o nome da Lambda
